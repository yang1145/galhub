<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员账户管理 - GalHub</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .admin-header h1 {
            margin: 0;
        }
        
        /* 导航栏样式 */
        .admin-nav {
            margin-bottom: 2rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background-color: #e9ecef;
        }
        
        .nav-item.active {
            border-bottom: 3px solid #3498db;
            background-color: #ffffff;
            font-weight: 500;
        }
        
        .nav-item:not(:last-child) {
            border-right: 1px solid #dee2e6;
        }
        
        .nav-item.action {
            margin-left: auto;
            border-right: none;
            border-left: 1px solid #dee2e6;
        }
        
        .logout-btn {
            background: none;
            color: #e74c3c;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            width: 100%;
            text-align: left;
        }
        
        .logout-btn:hover {
            background-color: #ffeaea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .notification {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .admins-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .admins-list th,
        .admins-list td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .admins-list th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .admins-list tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-buttons button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .edit-form {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            max-width: 800px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <script>
        // 在页面加载前检查认证状态
        (function() {
            console.log('检查认证状态');
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.log('未找到认证令牌，重定向到登录页面');
                window.location.href = '/admin/login';
                return;
            }
            
            // 验证令牌有效性，使用需要认证的API端点
            fetch('/api/admin/verify', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            }).then(response => {
                if (response.status === 401 || response.status === 403) {
                    console.log('令牌无效，清除令牌并重定向到登录页面');
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                } else {
                    console.log('令牌有效，继续加载页面');
                }
            }).catch(error => {
                console.error('验证令牌时出错:', error);
                // 即使网络错误也继续加载页面
                console.log('网络错误，假设令牌有效，继续加载页面');
            });
        })();
    </script>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>管理员账户管理</h1>
        </div>
        
        <!-- 导航栏 -->
        <nav class="admin-nav">
            <ul class="nav-list">
                <li class="nav-item" data-tab="dashboard">仪表板</li>
                <li class="nav-item" data-tab="games">游戏管理</li>
                <li class="nav-item active" data-tab="accounts">账户管理</li>
                <li class="nav-item" data-tab="users">用户管理</li>
                <li class="nav-item action">
                    <button class="logout-btn" id="logoutBtn">退出登录</button>
                </li>
            </ul>
        </nav>
        
        <div class="tab-content active" id="adminsTab">
            <h2>管理员账户列表</h2>
            <div id="notification" class="notification hidden"></div>
            
            <div id="adminsList">
                <table class="admins-list">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="adminsTableBody">
                        <!-- 管理员列表将通过JavaScript动态加载 -->
                        <tr>
                            <td colspan="4" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="addTab">
            <h2>添加管理员账户</h2>
            <div id="addNotification" class="notification hidden"></div>
            <form id="addAdminForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group form-col">
                        <label for="adminUsername">用户名 *</label>
                        <input type="text" id="adminUsername" required>
                    </div>
                    <div class="form-group form-col">
                        <label for="adminPassword">密码 *</label>
                        <input type="password" id="adminPassword" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">确认密码 *</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn">添加账户</button>
                    <button type="button" class="btn btn-secondary" id="resetFormBtn">重置</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let allAdmins = []; // 存储所有管理员账户
        
        // 初始化页面
        function initPage() {
            console.log('开始初始化页面');
            try {
                // 绑定事件监听器
                bindEventListeners();
                
                // 检查DOM状态
                if (document.readyState === 'loading') {
                    // 如果文档仍在加载，等待DOMContentLoaded事件
                    document.addEventListener('DOMContentLoaded', () => {
                        console.log('DOMContentLoaded事件触发');
                        // 添加加载指示器
                        const loader = document.createElement('div');
                        loader.id = 'pageLoader';
                        loader.style = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(255, 255, 255, 0.8);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            z-index: 9999;
                        `;
                        loader.innerHTML = `
                            <div style="text-align: center;">
                                <div class="spinner" style="margin: 0 auto; width: 40px; height: 40px; border: 4px solid #3498db; border-radius: 50%; border-top: 4px solid transparent; animation: spin 1s linear infinite;"></div>
                                <p style="margin-top: 1rem; color: #3498db;">加载中...</p>
                            </div>
                        `;
                        document.body.appendChild(loader);
                        
                        // 添加CSS动画
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        // 获取管理员账户列表
                        fetchAdmins().finally(() => {
                            // 移除加载指示器
                            setTimeout(() => {
                                const loaderElement = document.getElementById('pageLoader');
                                if (loaderElement) {
                                    loaderElement.remove();
                                }
                            }, 300); // 确保加载动画完整播放
                        });
                    });
                } else {
                    // 如果文档已经加载，直接获取管理员账户列表
                    fetchAdmins();
                }
            } catch (error) {
                console.error('初始化页面时发生错误:', error);
                showNotification('页面初始化失败，请刷新页面重试', 'error');
            }
        }
        
        // 执行页面初始化
        initPage();
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 导航功能
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switch(tab) {
                        case 'dashboard':
                            window.location.href = '/admin/dashboard';
                            break;
                        case 'games':
                            window.location.href = '/admin/edit-game';
                            break;
                        case 'accounts':
                            // 当前页面，不需要跳转
                            break;
                        case 'users':
                            window.location.href = '/admin/users';
                            break;
                    }
                });
            });
            
            // 添加管理员账户表单
            document.getElementById('addAdminForm').addEventListener('submit', addAdmin);
            
            // 重置表单按钮
            document.getElementById('resetFormBtn').addEventListener('click', resetAddForm);
        }
        
        // 切换Tab
        function switchTab() {
            // 移除所有导航项的active类
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活当前导航项
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // 获取管理员账户列表
        async function fetchAdmins() {
            console.log('开始获取管理员账户列表');
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            console.log('从localStorage获取的令牌:', token);
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                console.log('没有找到令牌，重定向到登录页面');
                handleUnauthorized();
                return;
            }
            
            try {
                console.log('发送获取管理员账户列表请求');
                const response = await fetch('/api/admins', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('获取管理员账户列表响应状态:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    // 注意：API返回的是 { success: true, data: [...] } 格式
                    allAdmins = result.data || [];
                    console.log('成功获取管理员账户列表，账户数量:', allAdmins.length);
                    renderAdminsList(allAdmins);
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期，重定向到登录页面
                    console.log('令牌无效或已过期，清除令牌并重定向到登录页面');
                    handleUnauthorized();
                } else {
                    console.log('获取管理员账户列表失败，状态码:', response.status);
                    showNotification('获取管理员账户列表失败', 'error');
                }
            } catch (error) {
                console.error('Error fetching admins:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    console.log('网络错误，但假设令牌仍然有效');
                    showNotification('网络连接错误', 'error');
                } else {
                    showNotification('获取管理员账户列表时发生错误', 'error');
                }
            }
        }
        
        // 渲染管理员账户列表
        function renderAdminsList(admins) {
            const tbody = document.getElementById('adminsTableBody');
            
            // 确保admins是数组
            if (!Array.isArray(admins) || admins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无管理员账户</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${admin.id}</td>
                    <td>${admin.username}</td>
                    <td>${new Date(admin.created_at).toLocaleString()}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger" onclick="deleteAdmin(${admin.id})">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 添加管理员账户
        async function addAdmin(event) {
            event.preventDefault();
            
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                handleUnauthorized();
                return;
            }
            
            // 获取表单数据
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // 简单验证
            if (password !== confirmPassword) {
                showAddNotification('两次输入的密码不一致', 'error');
                return;
            }
            
            const adminData = {
                username: username,
                password: password
            };
            
            try {
                const response = await fetch('/api/admins', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(adminData)
                });
                
                if (response.ok) {
                    showAddNotification('管理员账户添加成功', 'success');
                    // 重置表单
                    document.getElementById('addAdminForm').reset();
                    // 重新加载管理员账户列表
                    fetchAdmins();
                    // 切换到账户列表标签页
                    document.querySelector('.tab[data-tab="admins"]').click();
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else {
                    const errorData = await response.json();
                    showAddNotification('添加管理员账户失败: ' + (errorData.message || response.status), 'error');
                }
            } catch (error) {
                console.error('Error adding admin:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showAddNotification('网络连接错误', 'error');
                } else {
                    showAddNotification('添加管理员账户时发生错误', 'error');
                }
            }
        }
        
        // 删除管理员账户
        async function deleteAdmin(id) {
            if (!confirm('确定要删除这个管理员账户吗？此操作不可恢复。')) {
                return;
            }
            
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                handleUnauthorized();
                return;
            }
            
            // 检查是否是当前登录用户
            try {
                const currentAdmin = JSON.parse(atob(token.split('.')[1])); // 解码JWT获取用户信息
                
                // 验证JWT是否有正确的结构
                if (!currentAdmin || !currentAdmin.id) {
                    console.error('Invalid token structure');
                    handleUnauthorized();
                    return;
                }
                
                if (currentAdmin.id == id) {
                    showNotification('不能删除当前登录的账户', 'error');
                    return;
                }
            } catch (error) {
                console.error('Error decoding JWT token:', error);
                handleUnauthorized();
                return;
            }
            
            try {
                const response = await fetch(`/api/admins/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showNotification('管理员账户删除成功', 'success');
                        // 重新加载管理员账户列表
                        fetchAdmins();
                    } else {
                        showNotification('删除失败: ' + result.message, 'error');
                    }
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else if (response.status === 400) {
                    const errorData = await response.json();
                    showNotification('删除失败: ' + errorData.message, 'error');
                } else {
                    const errorData = await response.json();
                    showNotification('删除管理员账户失败: ' + (errorData.message || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showNotification('网络连接错误', 'error');
                } else {
                    showNotification('删除管理员账户时发生错误', 'error');
                }
            }
        }
        
        // 统一处理未授权情况
        function handleUnauthorized() {
            // 清除令牌
            localStorage.removeItem('adminToken');
            // 显示提示信息
            showNotification('登录已过期，请重新登录', 'error');
            // 重定向到登录页面
            setTimeout(() => {
                window.location.assign('/admin/login');
            }, 1500);
        }
        
        // 退出登录
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
        }
        
        // 重置添加表单
        function resetAddForm() {
            document.getElementById('addAdminForm').reset();
            const notification = document.getElementById('addNotification');
            notification.classList.add('hidden');
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 显示添加管理员账户通知
        function showAddNotification(message, type) {
            const notification = document.getElementById('addNotification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 全局函数，供HTML调用
        window.deleteAdmin = deleteAdmin;

        // 退出登录功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
        });
    }
</script>
</body>
</html>