<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - GalHub</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .admin-header h1 {
            margin: 0;
        }
        
        /* 导航栏样式 */
        .admin-nav {
            margin-bottom: 2rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background-color: #e9ecef;
        }
        
        .nav-item.active {
            border-bottom: 3px solid #3498db;
            background-color: #ffffff;
            font-weight: 500;
        }
        
        .nav-item:not(:last-child) {
            border-right: 1px solid #dee2e6;
        }
        
        .nav-item.action {
            margin-left: auto;
            border-right: none;
            border-left: 1px solid #dee2e6;
        }
        
        .logout-btn {
            background: none;
            color: #e74c3c;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            width: 100%;
            text-align: left;
        }
        
        .logout-btn:hover {
            background-color: #ffeaea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .notification {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .users-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .users-list th,
        .users-list td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .users-list th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .users-list tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-buttons button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .edit-form {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            max-width: 800px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <script>
        // 在页面加载前检查认证状态
        (function() {
            console.log('检查认证状态');
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.log('未找到认证令牌，重定向到登录页面');
                window.location.href = '/admin/login';
                return;
            }
            
            // 验证令牌有效性，使用需要认证的API端点
            fetch('/api/admin/verify', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            }).then(response => {
                if (response.status === 401 || response.status === 403) {
                    console.log('令牌无效，清除令牌并重定向到登录页面');
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                } else {
                    console.log('令牌有效，继续加载页面');
                }
            }).catch(error => {
                console.error('验证令牌时出错:', error);
                // 即使网络错误也继续加载页面
                console.log('网络错误，假设令牌有效，继续加载页面');
            });
        })();
    </script>
    
    <div class="admin-container">
        <!-- 加载指示器 -->
        <div id="loadingIndicator" class="notification info hidden"></div>
                
        <div class="admin-header">
            <h1>用户管理</h1>
        </div>
        
        <!-- 导航栏 -->
        <nav class="admin-nav">
            <ul class="nav-list">
                <li class="nav-item" data-tab="dashboard">仪表板</li>
                <li class="nav-item" data-tab="games">游戏管理</li>
                <li class="nav-item" data-tab="accounts">账户管理</li>
                <li class="nav-item active" data-tab="users">用户管理</li>
                <li class="nav-item action">
                    <button class="logout-btn" id="logoutBtn">退出登录</button>
                </li>
            </ul>
        </nav>
        
        <div class="tab-content active" id="usersTab">
            <h2>用户列表</h2>
            <div id="notification" class="notification hidden"></div>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索用户名或邮箱...">
                <button class="btn" id="searchBtn">搜索</button>
                <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
            </div>
            
            <div id="usersList">
                <table class="users-list">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>用户名</th>
                            <th>邮箱</th>
                            <th>创建时间</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 用户列表将通过JavaScript动态加载 -->
                        <tr>
                            <td colspan="6" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="addTab">
            <h2>添加用户</h2>
            <div id="addNotification" class="notification hidden"></div>
            <form id="addUserForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group form-col">
                        <label for="username">用户名 *</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group form-col">
                        <label for="email">邮箱 *</label>
                        <input type="email" id="email" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group form-col">
                        <label for="password">密码 *</label>
                        <input type="password" id="password" required>
                    </div>
                    <div class="form-group form-col">
                        <label for="confirmPassword">确认密码 *</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="isActive" checked> 账户激活
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn">添加用户</button>
                    <button type="button" class="btn btn-secondary" id="resetFormBtn">重置</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let allUsers = []; // 存储所有用户
        let filteredUsers = []; // 存储过滤后的用户
        
        // 显示加载状态
        function showLoading(loadingText = '加载中...') {
            const loadingElement = document.getElementById('loadingIndicator');
            if (loadingElement) {
                loadingElement.textContent = loadingText;
                loadingElement.classList.remove('hidden');
            }
        }
        
        // 隐藏加载状态
        function hideLoading() {
            const loadingElement = document.getElementById('loadingIndicator');
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        }
        
        // 初始化页面
        function initPage() {
            try {
                console.log('开始初始化页面');
                bindEventListeners();
                fetchUsers();
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败: ' + error.message, 'error');
                hideLoading();
            }
        }
        
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            
            // 添加加载状态
            const contentArea = document.querySelector('.admin-container');
            if (contentArea) {
                contentArea.insertAdjacentHTML('afterbegin', `
                    <div id="loadingIndicator" class="notification info hidden"></div>
                `);
            }
            
            // 初始化页面
            initPage();
        });
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 导航功能
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switch(tab) {
                        case 'dashboard':
                            window.location.href = '/admin/dashboard';
                            break;
                        case 'games':
                            window.location.href = '/admin/edit-game';
                            break;
                        case 'accounts':
                            window.location.href = '/admin/accounts';
                            break;
                        case 'users':
                            // 当前页面，不需要跳转
                            break;
                    }
                });
            });
            
            // 添加用户表单
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                addUserForm.addEventListener('submit', addUser);
            }
            
            // 重置表单按钮
            const resetFormBtn = document.getElementById('resetFormBtn');
            if (resetFormBtn) {
                resetFormBtn.addEventListener('click', resetAddForm);
            }
            
            // 搜索功能
            const searchBtn = document.getElementById('searchBtn');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const searchInput = document.getElementById('searchInput');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', searchUsers);
            }
            
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', clearSearch);
            }
            
            if (searchInput) {
                searchInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        searchUsers();
                    }
                });
            }
        }
        
        // 切换Tab
        function switchTab() {
            // 移除所有导航项的active类
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活当前导航项
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // 获取用户列表
        async function fetchUsers() {
            console.log('开始获取用户列表');
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            console.log('从localStorage获取的令牌:', token);
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                console.log('没有找到令牌，重定向到登录页面');
                handleUnauthorized();
                return;
            }
            
            try {
                console.log('发送获取用户列表请求');
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('获取用户列表响应状态:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    allUsers = result.data || [];
                    filteredUsers = [...allUsers];
                    console.log('成功获取用户列表，用户数量:', allUsers.length);
                    renderUsersList(filteredUsers);
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期，重定向到登录页面
                    console.log('令牌无效或已过期，清除令牌并重定向到登录页面');
                    handleUnauthorized();
                } else {
                    console.log('获取用户列表失败，状态码:', response.status);
                    showNotification('获取用户列表失败', 'error');
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    console.log('网络错误，但假设令牌仍然有效');
                    showNotification('网络连接错误', 'error');
                } else {
                    showNotification('获取用户列表时发生错误', 'error');
                }
            }
        }
        
        // 渲染用户列表
        function renderUsersList(users) {
            const tbody = document.getElementById('usersTableBody');
            
            // 确保users是数组
            if (!Array.isArray(users) || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无用户</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.created_at).toLocaleString()}</td>
                    <td>${user.is_active ? '激活' : '未激活'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 添加用户
        async function addUser(event) {
            event.preventDefault();
            
            // 显示加载状态
            const submitBtn = document.querySelector('#addUserForm button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';
            
            try {
                // 从localStorage获取最新的令牌
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    // 如果没有令牌，重定向到登录页面
                    handleUnauthorized();
                    return;
                }
                
                // 获取表单数据
                const username = document.getElementById('username').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const isActive = document.getElementById('isActive').checked;
                
                // 高级验证
                if (password !== confirmPassword) {
                    throw new Error('两次输入的密码不一致');
                }
                
                if (password.length < 8) {
                    throw new Error('密码长度至少为8位');
                }
                
                // 密码复杂度验证（至少包含大小写字母和数字）
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
                if (!passwordRegex.test(password)) {
                    throw new Error('密码必须包含大小写字母和数字');
                }
                
                // 邮箱格式验证
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    throw new Error('请输入有效的邮箱地址');
                }
                
                const userData = {
                    username: username,
                    email: email,
                    password: password,
                    is_active: isActive
                };
                
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(userData)
                });
                
                if (response.ok) {
                    showAddNotification('用户添加成功', 'success');
                    // 重置表单
                    document.getElementById('addUserForm').reset();
                    // 重新加载用户列表
                    await fetchUsers();
                    // 切换到用户列表标签页
                    document.querySelector('.nav-item[data-tab="users"]').click();
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else {
                    const errorData = await response.json();
                    throw new Error(`添加用户失败: ${errorData.message || errorData.error || response.status}`);
                }
            } catch (error) {
                console.error('Error adding user:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showAddNotification('网络连接错误', 'error');
                } else {
                    showAddNotification(error.message, 'error');
                }
            } finally {
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }
        
        // 删除用户
        async function deleteUser(id) {
            if (!confirm('确定要删除这个用户吗？此操作不可恢复。')) {
                return;
            }
            
            // 获取令牌并验证
            const token = validateAdminToken();
            if (!token) {
                handleUnauthorized();
                return;
            }
            
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.message || errorData.error || `HTTP错误: ${response.status}`;
                    
                    // 处理不同的错误类型
                    switch(response.status) {
                        case 401:
                        case 403:
                            handleUnauthorized();
                            break;
                        case 404:
                            showNotification('用户不存在', 'error');
                            break;
                        case 409:
                            showNotification('无法删除有相关数据的用户', 'error');
                            break;
                        default:
                            showNotification(`删除用户失败: ${errorMessage}`, 'error');
                    }
                    
                    console.error('删除用户失败:', {
                        status: response.status,
                        error: errorData
                    });
                    return;
                }
                
                // 成功处理
                showNotification('用户删除成功', 'success');
                console.log(`用户 ${id} 已成功删除`);
                
                // 重新加载用户列表
                await fetchUsers();
            } catch (error) {
                console.error('删除用户时发生严重错误:', {
                    error: error,
                    stack: error.stack
                });
                
                // 网络错误或其他异常
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showNotification('网络连接异常，请检查您的网络', 'error');
                } else if (error.name === 'AbortError') {
                    showNotification('请求超时，请重试', 'error');
                } else {
                    showNotification('发生未知错误，请重试', 'error');
                }
            }
        }
        
        // 验证管理员令牌
        function validateAdminToken() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.warn('未找到管理员令牌');
                return null;
            }
            
            // 可以添加更复杂的验证逻辑，例如JWT解码验证
            // const payload = parseJwt(token);
            // if (payload.exp < Date.now() / 1000) {
            //     console.warn('令牌已过期');
            //     return null;
            // }
            
            return token;
        }
        
        // 解析JWT令牌（可选功能）
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('解析JWT令牌失败:', error);
                return null;
            }
        }
        
        // 搜索用户
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredUsers = [...allUsers];
            } else {
                filteredUsers = allUsers.filter(user => 
                    user.username.toLowerCase().includes(searchTerm) || 
                    user.email.toLowerCase().includes(searchTerm)
                );
            }
            
            renderUsersList(filteredUsers);
        }
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filteredUsers = [...allUsers];
            renderUsersList(filteredUsers);
        }
        
        // 统一处理未授权情况
        function handleUnauthorized() {
            // 清除令牌
            localStorage.removeItem('adminToken');
            // 显示提示信息
            showNotification('登录已过期，请重新登录', 'error');
            // 重定向到登录页面
            setTimeout(() => {
                window.location.assign('/admin/login');
            }, 1500);
        }
        
        // 退出登录
        function logout() {
            // 清除登录信息
            localStorage.removeItem('adminToken');
            // 重定向到首页
            window.location.assign('/');
            // 阻止事件冒泡
            return false;
        }
        
        // 重置添加用户表单
        function resetAddForm() {
            document.getElementById('addUserForm').reset();
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 显示添加用户通知
        function showAddNotification(message, type) {
            const notification = document.getElementById('addNotification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 全局函数，供HTML调用
        window.deleteUser = deleteUser;

        // 退出登录功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
        });
    });
</script>
</body>
</html>