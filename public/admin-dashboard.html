<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理面板 - GalHub</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .admin-header h1 {
            margin: 0;
        }
        
        /* 导航栏样式 */
        .admin-nav {
            margin-bottom: 2rem;
            background-color: #f8f9fa;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }
        
        .nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }
        
        .nav-item:hover {
            background-color: #e9ecef;
        }
        
        .nav-item.active {
            border-bottom: 3px solid #3498db;
            background-color: #ffffff;
            font-weight: 500;
        }
        
        .nav-item:not(:last-child) {
            border-right: 1px solid #dee2e6;
        }
        
        .nav-item.action {
            margin-left: auto;
            border-right: none;
            border-left: 1px solid #dee2e6;
        }
        
        .logout-btn {
            background: none;
            color: #e74c3c;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.95rem;
            width: 100%;
            text-align: left;
        }
        
        .logout-btn:hover {
            background-color: #ffeaea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .checkbox-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 0.5rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .search-container {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .search-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .search-container button {
            padding: 0.75rem 1.5rem;
        }
        
        .games-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .games-list th,
        .games-list td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .games-list th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .games-list tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-buttons button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .edit-form {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 2rem;
            max-width: 800px;
        }
        
        .notification {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        /* 新增样式：优化表单布局 */
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .form-col {
            flex: 1;
            min-width: 250px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <script>
        // 在页面加载前检查认证状态
        (function() {
            console.log('检查认证状态');
            const token = localStorage.getItem('adminToken');
            if (!token) {
                console.log('未找到认证令牌，重定向到登录页面');
                window.location.href = '/admin/login';
                return;
            }
            
            // 验证令牌有效性，使用需要认证的API端点
            fetch('/api/admin/verify', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            }).then(response => {
                if (response.status === 401 || response.status === 403) {
                    console.log('令牌无效，清除令牌并重定向到登录页面');
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                } else {
                    console.log('令牌有效，继续加载页面');
                }
            }).catch(error => {
                console.error('验证令牌时出错:', error);
                // 即使网络错误也继续加载页面
                console.log('网络错误，假设令牌有效，继续加载页面');
            });
        })();
    </script>
    
    <div class="admin-container">
        <div class="admin-header">
            <h1>管理面板</h1>
        </div>
        
        <!-- 导航栏 -->
        <nav class="admin-nav">
            <ul class="nav-list">
                <li class="nav-item active" data-tab="dashboard">仪表板</li>
                <li class="nav-item" data-tab="games">游戏管理</li>
                <li class="nav-item" data-tab="accounts">账户管理</li>
                <li class="nav-item" data-tab="users">用户管理</li>
                <li class="nav-item action">
                    <button class="logout-btn" id="logoutBtn">退出登录</button>
                </li>
            </ul>
        </nav>
        
        <div class="tab-content active" id="gamesTab">
            <h2>游戏列表</h2>
            <div id="notification" class="notification hidden"></div>
            
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="搜索游戏名称、别名、作者...">
                <button class="btn" id="searchBtn">搜索</button>
                <button class="btn btn-secondary" id="clearSearchBtn">清除</button>
            </div>
            
            <div id="gamesList">
                <table class="games-list">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>游戏名称</th>
                            <th>别名</th>
                            <th>作者</th>
                            <th>地址</th>
                            <th>商业游戏</th>
                            <th>转载</th>
                            <th>维护中</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="gamesTableBody">
                        <!-- 游戏列表将通过JavaScript动态加载 -->
                        <tr>
                            <td colspan="9" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-content" id="addTab">
            <h2>添加新游戏</h2>
            <div id="addNotification" class="notification hidden"></div>
            <form id="addGameForm" class="edit-form">
                <div class="form-row">
                    <div class="form-group form-col">
                        <label for="gameName">游戏名称 *</label>
                        <input type="text" id="gameName" required>
                    </div>
                    <div class="form-group form-col">
                        <label for="gameAlias">游戏别名</label>
                        <input type="text" id="gameAlias">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group form-col">
                        <label for="coverLink">封面链接</label>
                        <input type="text" id="coverLink">
                    </div>
                    <div class="form-group form-col">
                        <label for="gameAddress">游戏地址</label>
                        <input type="text" id="gameAddress">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="gameAuthor">作者</label>
                    <input type="text" id="gameAuthor">
                </div>
                
                <div class="form-group">
                    <label>游戏属性</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="isCommercial"> 商业游戏
                        </label>
                        <label>
                            <input type="checkbox" id="isRepost"> 转载
                        </label>
                        <label>
                            <input type="checkbox" id="isMaintained" checked> 维护中
                        </label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn">添加游戏</button>
                    <button type="button" class="btn btn-secondary" id="resetFormBtn">重置</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 移除checkLoginStatus函数中的重定向逻辑，仅保留API请求时的认证检查
        // 全局变量
        let allGames = []; // 存储所有游戏数据
        let editWindows = {}; // 存储打开的编辑窗口
        
        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            // 绑定事件监听器
            bindEventListeners();
            
            // 获取游戏列表
            fetchGames();
            
            // 监听来自子窗口的消息
            window.addEventListener('message', handleWindowMessage);
        });
        
        // 检查登录状态
        function checkLoginStatus() {
            console.log('开始检查登录状态');
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            console.log('检查登录状态，token:', token);
            
            if (!token) {
                // 没有令牌，返回拒绝的Promise
                console.log('没有找到认证令牌');
                return Promise.reject(new Error('No token found'));
            }
            
            // 发送一个简单的请求到需要认证的API端点来验证令牌的有效性
            // 这比仅仅解析JWT更可靠
            console.log('发送请求验证令牌有效性');
            return fetch('/api/games', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/json'
                }
            }).then(response => {
                console.log('认证检查响应状态:', response.status);
                if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期，清除
                    console.log('令牌无效或已过期，清除令牌');
                    localStorage.removeItem('adminToken');
                    return Promise.reject(new Error('Invalid or expired token'));
                }
                // 如果令牌有效，什么也不做，允许页面继续加载
                console.log('令牌有效，继续加载页面');
                return Promise.resolve();
            }).catch(error => {
                console.error('检查认证状态时出错:', error);
                // 如果是网络错误，我们可以假设令牌仍然有效
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    console.log('网络错误，假设令牌仍然有效');
                    return Promise.resolve();
                }
                // 其他错误情况，不处理令牌，不重定向
                console.log('认证检查出现非授权错误，不重定向');
                // 但如果是明确的认证错误，还是要处理的
                if (error.message === 'Invalid or expired token' || error.message === 'No token found') {
                    return Promise.reject(error);
                }
                return Promise.resolve();
            });
        }
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('adminToken');
                window.location.href = '/admin/login';
            });
            
            // 导航功能
            document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switch(tab) {
                        case 'dashboard':
                            window.location.href = '/admin/dashboard';
                            break;
                        case 'games':
                            window.location.href = '/admin/edit-game';
                            break;
                        case 'accounts':
                            window.location.href = '/admin/accounts';
                            break;
                        case 'users':
                            window.location.href = '/admin/users';
                            break;
                    }
                });
            });
            
            // 搜索功能
            document.getElementById('searchBtn').addEventListener('click', searchGames);
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
            document.getElementById('searchInput').addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    searchGames();
                }
            });
            
            // 添加游戏表单
            document.getElementById('addGameForm').addEventListener('submit', addGame);
            
            // 重置表单按钮
            document.getElementById('resetFormBtn').addEventListener('click', resetAddForm);
        }
        
        // 处理来自子窗口的消息
        function handleWindowMessage(event) {
            // 确保消息来自同源
            if (event.origin !== window.location.origin) return;
            
            // 根据消息内容执行相应操作
            if (event.data.action === 'gameUpdated' || event.data.action === 'gameDeleted') {
                // 重新加载游戏列表
                fetchGames();
            }
        }
        
        // 切换Tab
        function switchTab() {
            // 移除所有导航项的active类
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活当前导航项
            this.classList.add('active');
            const tabName = this.getAttribute('data-tab');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // 获取游戏列表
        async function fetchGames() {
            console.log('开始获取游戏列表');
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            console.log('从localStorage获取的令牌:', token);
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                console.log('没有找到令牌，重定向到登录页面');
                handleUnauthorized();
                return;
            }
            
            try {
                console.log('发送获取游戏列表请求');
                const response = await fetch('/api/games', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('获取游戏列表响应状态:', response.status);
                if (response.ok) {
                    allGames = await response.json();
                    console.log('成功获取游戏列表，游戏数量:', allGames.length);
                    renderGamesList(allGames);
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期，重定向到登录页面
                    console.log('令牌无效或已过期，清除令牌并重定向到登录页面');
                    handleUnauthorized();
                } else {
                    console.log('获取游戏列表失败，状态码:', response.status);
                    showNotification('获取游戏列表失败', 'error');
                }
            } catch (error) {
                console.error('Error fetching games:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    console.log('网络错误，但假设令牌仍然有效');
                    showNotification('网络连接错误', 'error');
                } else {
                    showNotification('获取游戏列表时发生错误', 'error');
                }
            }
        }
        
        // 执行搜索
        function searchGames() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderGamesList(allGames);
                return;
            }
            
            const filteredGames = allGames.filter(game => {
                return (
                    (game.name && game.name.toLowerCase().includes(searchTerm)) ||
                    (game.alias && game.alias.toLowerCase().includes(searchTerm)) ||
                    (game.author && game.author.toLowerCase().includes(searchTerm))
                );
            });
            
            renderGamesList(filteredGames);
        }
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            renderGamesList(allGames);
        }
        
        // 渲染游戏列表
        function renderGamesList(games) {
            const tbody = document.getElementById('gamesTableBody');
            
            if (games.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暂无匹配的游戏数据</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            games.forEach(game => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${game.id}</td>
                    <td>${game.name}</td>
                    <td>${game.alias || ''}</td>
                    <td>${game.author || ''}</td>
                    <td>${game.game_address || ''}</td>
                    <td>${game.is_commercial ? '是' : '否'}</td>
                    <td>${game.is_repost ? '是' : '否'}</td>
                    <td>${game.is_maintained ? '是' : '否'}</td>
                    <td class="action-buttons">
                        <button class="btn" onclick="editGame(${game.id})">编辑</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 编辑游戏 - 打开新窗口
        function editGame(id) {
            // 如果已经有一个编辑该ID游戏的窗口，就将其聚焦
            if (editWindows[id] && !editWindows[id].closed) {
                editWindows[id].focus();
                return;
            }
            
            // 打开新的编辑窗口
            const editWindow = window.open(
                `/edit-game.html?id=${id}`,
                `editGame${id}`,
                'width=800,height=700,scrollbars=yes,resizable=yes'
            );
            
            // 将窗口存储在全局变量中
            editWindows[id] = editWindow;
        }
        
        // 统一处理未授权情况
        function handleUnauthorized() {
            // 清除令牌
            localStorage.removeItem('adminToken');
            // 显示提示信息
            showNotification('登录已过期，请重新登录', 'error');
            // 重定向到登录页面
            setTimeout(() => {
                window.location.assign('/admin/login');
            }, 1500);
        }
        
        // 添加游戏
        async function addGame(event) {
            event.preventDefault();
            
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                handleUnauthorized();
                return;
            }
            
            const gameData = {
                name: document.getElementById('gameName').value,
                alias: document.getElementById('gameAlias').value,
                cover_link: document.getElementById('coverLink').value,
                game_address: document.getElementById('gameAddress').value,
                author: document.getElementById('gameAuthor').value,
                is_commercial: document.getElementById('isCommercial').checked,
                is_repost: document.getElementById('isRepost').checked,
                is_maintained: document.getElementById('isMaintained').checked
            };
            
            try {
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(gameData)
                });
                
                if (response.ok) {
                    showAddNotification('游戏添加成功', 'success');
                    // 重置表单
                    document.getElementById('addGameForm').reset();
                    document.getElementById('isMaintained').checked = true;
                    // 重新加载游戏列表
                    fetchGames();
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else {
                    showAddNotification('添加游戏失败: ' + response.status, 'error');
                }
            } catch (error) {
                console.error('Error adding game:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showAddNotification('网络连接错误，请检查网络连接', 'error');
                } else if (error.name === 'AbortError') {
                    showAddNotification('请求超时，请重试', 'error');
                } else {
                    showAddNotification('添加游戏时发生未知错误', 'error');
                }
            } finally {
                // 确保无论成功或失败都重新启用提交按钮
                const submitButton = document.querySelector('#addGameForm button[type="submit"]');
                if (submitButton) {
                    submitButton.disabled = false;
                }
            }
        }
        
        // 在全局作用域添加abort控制器
        let addGameAbortController = null;
        
        // 修改添加游戏函数以支持请求超时
        async function addGame(event) {
            event.preventDefault();
            
            // 取消之前的请求（如果存在）
            if (addGameAbortController) {
                addGameAbortController.abort();
            }
            
            // 创建新的AbortController
            addGameAbortController = new AbortController();
            const signal = addGameAbortController.signal;
            
            // 禁用提交按钮以防止重复提交
            const submitButton = document.querySelector('#addGameForm button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
            }
            
            // 从localStorage获取最新的令牌
            const token = localStorage.getItem('adminToken');
            if (!token) {
                // 如果没有令牌，重定向到登录页面
                handleUnauthorized();
                return;
            }
            
            const gameData = {
                name: document.getElementById('gameName').value,
                alias: document.getElementById('gameAlias').value,
                cover_link: document.getElementById('coverLink').value,
                game_address: document.getElementById('gameAddress').value,
                author: document.getElementById('gameAuthor').value,
                is_commercial: document.getElementById('isCommercial').checked,
                is_repost: document.getElementById('isRepost').checked,
                is_maintained: document.getElementById('isMaintained').checked
            };
            
            try {
                // 设置5秒超时
                const timeout = setTimeout(() => {
                    addGameAbortController.abort();
                    showAddNotification('请求超时，请重试', 'error');
                }, 5000);
                
                const response = await fetch('/api/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(gameData),
                    signal: signal
                });
                
                clearTimeout(timeout);
                
                if (response.ok) {
                    showAddNotification('游戏添加成功', 'success');
                    // 重置表单
                    document.getElementById('addGameForm').reset();
                    document.getElementById('isMaintained').checked = true;
                    // 重新加载游戏列表
                    fetchGames();
                } else if (response.status === 401 || response.status === 403) {
                    // 令牌无效或过期
                    handleUnauthorized();
                } else {
                    showAddNotification('添加游戏失败: ' + response.status, 'error');
                }
            } catch (error) {
                console.error('Error adding game:', error);
                // 特别处理网络错误
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showAddNotification('网络连接错误', 'error');
                } else {
                    showAddNotification('添加游戏时发生错误', 'error');
                }
            }
        }
        
        // 重置添加游戏表单
        function resetAddForm() {
            document.getElementById('addGameForm').reset();
            document.getElementById('isMaintained').checked = true;
        }
        
        // 退出登录
        function logout() {
            // 清除登录信息
            localStorage.removeItem('adminToken');
            // 重定向到首页
            window.location.assign('/');
            // 阻止事件冒泡
            return false;
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 显示添加游戏通知
        function showAddNotification(message, type) {
            const notification = document.getElementById('addNotification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
        
        // 全局函数，供HTML调用
        window.editGame = editGame;
    </script>
</body>
</html>